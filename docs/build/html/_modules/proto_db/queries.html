

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>proto_db.queries &mdash; ProtoBase 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ProtoBase
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced_usage.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development.html">Development</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ProtoBase</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">proto_db.queries</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for proto_db.queries</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">selectors</span> <span class="kn">import</span> <span class="n">SelectSelector</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>

<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">DBCollections</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">ProtoUnexpectedException</span><span class="p">,</span> <span class="n">ProtoValidationException</span><span class="p">,</span> <span class="n">ProtoCorruptionException</span>
<span class="kn">from</span> <span class="nn">.common</span> <span class="kn">import</span> <span class="n">Atom</span><span class="p">,</span> <span class="n">QueryPlan</span><span class="p">,</span> <span class="n">AtomPointer</span><span class="p">,</span> <span class="n">DBObject</span>
<span class="kn">from</span> <span class="nn">.db_access</span> <span class="kn">import</span> <span class="n">ObjectTransaction</span>
<span class="kn">from</span> <span class="nn">.lists</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">.dictionaries</span> <span class="kn">import</span> <span class="n">RepeatedKeysDictionary</span><span class="p">,</span> <span class="n">Dictionary</span><span class="p">,</span> <span class="n">DictionaryItem</span>
<span class="kn">from</span> <span class="nn">.sets</span> <span class="kn">import</span> <span class="n">Set</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">from</span> <span class="nn">.hybrid_executor</span> <span class="kn">import</span> <span class="n">HybridExecutor</span>


<span class="c1"># Executor for async operations</span>
<span class="n">max_workers</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
<span class="n">executor_pool</span> <span class="o">=</span> <span class="n">HybridExecutor</span><span class="p">(</span><span class="n">base_num_workers</span><span class="o">=</span><span class="n">max_workers</span> <span class="o">//</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sync_multiplier</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Expression</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for all expression types used to filter or match records.</span>

<span class="sd">    Expressions represent logical conditions that can be applied to records, such as</span>
<span class="sd">    &quot;and&quot;, &quot;or&quot;, &quot;not&quot;, or specific comparisons (terms). Subclasses must implement</span>
<span class="sd">    the `match` method to define their behavior for evaluating a record.</span>

<span class="sd">    The `Expression` structure is highly flexible and supports composition of multiple</span>
<span class="sd">    logical operators for complex filtering.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">expression</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Expression</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compile a nested list of expressions into an `Expression` object.</span>

<span class="sd">        The method parses a structured list, where operators (`!`, `&amp;`, and `|`)</span>
<span class="sd">        and terms are used to build a tree of expressions (e.g., AndExpression,</span>
<span class="sd">        OrExpression, etc.). These compiled objects can then be used to evaluate</span>
<span class="sd">        whether a record satisfies the given conditions.</span>

<span class="sd">        :param expression: A nested list representing logical operations and terms.</span>
<span class="sd">        :type expression: list</span>
<span class="sd">        :return: A fully compiled `Expression` instance.</span>
<span class="sd">        :rtype: Expression</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">collect_expression</span><span class="p">(</span><span class="n">local_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Expression</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">expression</span><span class="p">[</span><span class="n">local_index</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;!&#39;</span><span class="p">:</span>
                <span class="n">local_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">following_expression</span><span class="p">,</span> <span class="n">local_index</span> <span class="o">=</span> <span class="n">collect_expression</span><span class="p">(</span><span class="n">local_index</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">NotExpression</span><span class="p">(</span><span class="n">following_expression</span><span class="p">),</span> <span class="n">local_index</span>
            <span class="k">elif</span> <span class="n">expression</span><span class="p">[</span><span class="n">local_index</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">:</span>
                <span class="n">local_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">first_operand</span><span class="p">,</span> <span class="n">local_index</span> <span class="o">=</span> <span class="n">collect_expression</span><span class="p">(</span><span class="n">local_index</span><span class="p">)</span>
                <span class="n">second_operand</span><span class="p">,</span> <span class="n">local_index</span> <span class="o">=</span> <span class="n">collect_expression</span><span class="p">(</span><span class="n">local_index</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">AndExpression</span><span class="p">([</span><span class="n">first_operand</span><span class="p">,</span> <span class="n">second_operand</span><span class="p">]),</span> <span class="n">local_index</span>
            <span class="k">elif</span> <span class="n">expression</span><span class="p">[</span><span class="n">local_index</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;|&#39;</span><span class="p">:</span>
                <span class="n">local_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">first_operand</span><span class="p">,</span> <span class="n">local_index</span> <span class="o">=</span> <span class="n">collect_expression</span><span class="p">(</span><span class="n">local_index</span><span class="p">)</span>
                <span class="n">second_operand</span><span class="p">,</span> <span class="n">local_index</span> <span class="o">=</span> <span class="n">collect_expression</span><span class="p">(</span><span class="n">local_index</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">OrExpression</span><span class="p">([</span><span class="n">first_operand</span><span class="p">,</span> <span class="n">second_operand</span><span class="p">]),</span> <span class="n">local_index</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># It should be a plain term</span>
                <span class="n">term_def</span> <span class="o">=</span> <span class="n">expression</span><span class="p">[</span><span class="n">local_index</span><span class="p">]</span>
                <span class="n">local_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">term_def</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Invalid term definition: </span><span class="si">{</span><span class="n">term_def</span><span class="si">}</span><span class="s1">. It should contain at least two operands!&#39;</span>
                    <span class="p">)</span>
                <span class="n">operand</span> <span class="o">=</span> <span class="n">Operator</span><span class="o">.</span><span class="n">get_operator</span><span class="p">(</span><span class="n">term_def</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">term_def</span><span class="p">)</span> <span class="o">!=</span> <span class="n">operand</span><span class="o">.</span><span class="n">parameter_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Operand </span><span class="si">{</span><span class="n">operand</span><span class="si">}</span><span class="s1"> expect at list </span><span class="si">{</span><span class="n">operand</span><span class="o">.</span><span class="n">parameter_count</span><span class="si">}</span><span class="s1"> parameters!&#39;</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="n">term_def</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">operand</span><span class="p">,</span> <span class="n">term_def</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">local_index</span>

        <span class="n">default_and_expression</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>
            <span class="n">new_expression</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">collect_expression</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">default_and_expression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_expression</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_and_expression</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AndExpression</span><span class="p">(</span><span class="n">default_and_expression</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default_and_expression</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">filter_by_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Term</span><span class="p">):</span>
            <span class="n">atribute_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_attribute</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">atribute_alias</span> <span class="ow">in</span> <span class="n">alias</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">TrueTerm</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">AndExpression</span><span class="p">):</span>
            <span class="n">new_operands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Expression</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">:</span>
                <span class="n">new_operands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operand</span><span class="o">.</span><span class="n">filter_by_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">AndExpression</span><span class="p">(</span><span class="n">new_operands</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OrExpression</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">TrueTerm</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NotExpression</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">NotExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">negated_expression</span><span class="o">.</span><span class="n">filter_by_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;It&#39;s not possible to filter </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> expression by alias!&quot;</span>
            <span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Matches a given record against specific criteria defined by the implementation.</span>

<span class="sd">        This method is abstract and must be implemented by a subclass to provide the</span>
<span class="sd">        logic for determining whether the provided record satisfies the required</span>
<span class="sd">        conditions. The exact nature of the matching depends on the subclass</span>
<span class="sd">        implementation.</span>

<span class="sd">        :param record: The record to be evaluated.</span>
<span class="sd">        :type record: Any</span>
<span class="sd">        :return: A boolean value indicating whether the record matches the criteria.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">AndExpression</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Logical &#39;AND&#39; expression for combining multiple conditions.</span>

<span class="sd">    Evaluates as True only if all terms in the `terms` list evaluate to True for a record.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    - terms (list[Expression]): Sub-expressions that must all evaluate as True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">terms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Expression</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Expression</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="n">terms</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate if the given record matches all sub-term conditions.</span>

<span class="sd">        :param record: The input record to evaluate.</span>
<span class="sd">        :type record: Any</span>
<span class="sd">        :return: True if all terms match the record, False otherwise.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">term</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">OrExpression</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="n">terms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Expression</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Expression</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="n">terms</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">NotExpression</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="n">negated_expression</span><span class="p">:</span> <span class="n">Expression</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">negated_expression</span><span class="p">:</span> <span class="n">Expression</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">negated_expression</span> <span class="o">=</span> <span class="n">negated_expression</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">negated_expression</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Operator</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for comparison operators.</span>

<span class="sd">    Operators define how a source value should be compared to another value</span>
<span class="sd">    to produce a boolean result. Subclasses implement different kinds of</span>
<span class="sd">    comparisons, such as equality, inequality, or inclusion.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    - parameter_count (int): The number of parameters this operator expects for comparison.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parameter_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_operator</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Factory method to get an operator instance based on a string representation.</span>

<span class="sd">        This allows dynamic resolution of operator behavior (e.g., &#39;==&#39;, &#39;!=&#39;, &#39;contains&#39;)</span>
<span class="sd">        at runtime. If the operator string is not recognized, an exception is raised.</span>

<span class="sd">        :param string: The string representation of the operator (e.g., &#39;==&#39;, &#39;in&#39;).</span>
<span class="sd">        :type string: str</span>
<span class="sd">        :return: An instance of a subclass of `Operator`.</span>
<span class="sd">        :rtype: Operator</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;==&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Equal</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;!=&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NotEqual</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Greater</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GreaterOrEqual</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Lower</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">LowerOrEqual</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;contains&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Contains</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">In</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;?T&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">IsTrue</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;?!T&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NotTrue</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;?N&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">IsNone</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;?!N&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NotNone</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Unknown operator: </span><span class="si">{</span><span class="n">string</span><span class="si">}</span><span class="s1">!&#39;</span>
            <span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is an abstract method that should be implemented in derived</span>
<span class="sd">        classes. It is designed to match the provided source against a specific</span>
<span class="sd">        value and return a result based on this matching process. The exact</span>
<span class="sd">        implementation and criteria of the match are dependent on the</span>
<span class="sd">        implementation in the subclass.</span>

<span class="sd">        :param source: The primary input against which the matching process</span>
<span class="sd">            will be performed. The exact nature of &#39;source&#39; depends on the</span>
<span class="sd">            implementation in the subclass.</span>
<span class="sd">        :param value: Optional value against which &#39;source&#39; will be matched.</span>
<span class="sd">            If not provided, the behavior may vary based on the subclass</span>
<span class="sd">            implementation.</span>
<span class="sd">        :return: The result of the matching process. The exact type and</span>
<span class="sd">            content of the returned value depend on the specific implementation</span>
<span class="sd">            in the subclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">Equal</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="n">parameter_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">source</span> <span class="o">==</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">NotEqual</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="n">parameter_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">source</span> <span class="o">!=</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">Greater</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="n">parameter_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">source</span> <span class="o">&gt;</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">GreaterOrEqual</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="n">parameter_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">source</span> <span class="o">&gt;=</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">Lower</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="n">parameter_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">source</span> <span class="o">&lt;</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">LowerOrEqual</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="n">parameter_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">source</span> <span class="o">&lt;=</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">Contains</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="n">parameter_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">source</span>


<span class="k">class</span> <span class="nc">In</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="n">parameter_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">IsTrue</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="n">parameter_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NotTrue</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="n">parameter_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">IsNone</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="n">parameter_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">NotNone</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="n">parameter_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">Term</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="n">target_attribute</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">operation</span><span class="p">:</span> <span class="n">Operator</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">object</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_attribute</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="n">Operator</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_attribute</span> <span class="o">=</span> <span class="n">target_attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">operation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_attribute</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">TrueTerm</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">FalseTerm</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="ListPlan">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.ListPlan">[docs]</a>
<span class="k">class</span> <span class="nc">ListPlan</span><span class="p">(</span><span class="n">QueryPlan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a QueryPlan from a python list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_list</span><span class="p">:</span> <span class="nb">list</span>

<div class="viewcode-block" id="ListPlan.__init__">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.ListPlan.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">base_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                 <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_list</span> <span class="o">=</span> <span class="n">base_list</span></div>


<div class="viewcode-block" id="ListPlan.execute">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.ListPlan.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_list</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">item</span></div>


<div class="viewcode-block" id="ListPlan.optimize">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.ListPlan.optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span></div>
</div>



<span class="k">class</span> <span class="nc">IndexedQueryPlan</span><span class="p">(</span><span class="n">QueryPlan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    IndexedQueryPlan is a specialized version of QueryPlan.</span>

<span class="sd">    It provides functionality for creating and managing indexed query plans</span>
<span class="sd">    that optimize query execution based on indexed data sources. This class</span>
<span class="sd">    extends the base functionality of QueryPlan to incorporate the use of</span>
<span class="sd">    indices in query operations.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">indexes</span><span class="p">:</span> <span class="n">Dictionary</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">indexes</span><span class="p">:</span> <span class="n">Dictionary</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">based_on</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span> <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">indexes</span> <span class="k">if</span> <span class="n">indexes</span> <span class="k">else</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">IndexedQueryPlan</span><span class="p">(</span>
            <span class="n">indexes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">,</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">),</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IndexedQueryPlan</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds an index to the database for optimizing query performance on specified columns. This method</span>
<span class="sd">        creates a new index with the given name on the columns specified in the list. Indexing can</span>
<span class="sd">        significantly improve the efficiency of certain queries, particularly for large datasets.</span>

<span class="sd">        :param field_name: field the index will be created on</span>
<span class="sd">        :return: An indexed query plan that contains details of the created index and its application</span>
<span class="sd">                 to the underlying query structure.</span>
<span class="sd">        :rtype: IndexedQueryPlan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">field_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Reindex the current content on the added field</span>
        <span class="n">new_index</span> <span class="o">=</span> <span class="n">RepeatedKeysDictionary</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">field_name</span><span class="p">):</span>
                <span class="n">new_index</span> <span class="o">=</span> <span class="n">new_index</span><span class="o">.</span><span class="n">set_at</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="n">record</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">IndexedQueryPlan</span><span class="p">(</span>
            <span class="n">indexes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">set_at</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">new_index</span><span class="p">),</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="p">,</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_indexes_on_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">removed_record</span><span class="p">:</span> <span class="n">Atom</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IndexedQueryPlan</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update indexes when specific data is removed from a collection or database.</span>

<span class="sd">        This function updates the internal indexes to maintain consistency</span>
<span class="sd">        after the specified data is removed. It ensures that subsequent</span>
<span class="sd">        queries reflect the correct indexed structure.</span>

<span class="sd">        :param removed_record: The data item that was removed, for which the</span>
<span class="sd">            indexes need to be updated.</span>
<span class="sd">        :return: An updated query plan reflecting the state of indexes</span>
<span class="sd">            after the removal.</span>
<span class="sd">        :rtype: IndexedQueryPlan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">as_iterable</span><span class="p">():</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RepeatedKeysDictionary</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">removed_record</span><span class="p">[</span><span class="n">field_name</span><span class="p">]:</span>
                <span class="n">new_indexes</span><span class="o">.</span><span class="n">set_at</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">index</span><span class="o">.</span><span class="n">remove_record_at</span><span class="p">(</span><span class="n">removed_record</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="n">removed_record</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">IndexedQueryPlan</span><span class="p">(</span>
            <span class="n">indexes</span><span class="o">=</span><span class="n">new_indexes</span><span class="p">,</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="p">,</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_indexes_on_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">added_record</span><span class="p">:</span> <span class="n">Atom</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IndexedQueryPlan</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the indexed query plan when an item is added to the dataset.</span>

<span class="sd">        The method ensures that the internal indexes are recalibrated after</span>
<span class="sd">        removing any existing data that would conflict with the new item&#39;s</span>
<span class="sd">        location or plan alignment in the indexed structure. It recalculates</span>
<span class="sd">        and returns the updated query plan that reflects the modifications.</span>

<span class="sd">        :param added_record: the added data.</span>
<span class="sd">        :return: The updated IndexedQueryPlan object after modification to</span>
<span class="sd">            reflect changes caused by the addition operation.</span>
<span class="sd">        :rtype: IndexedQueryPlan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">as_iterable</span><span class="p">():</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RepeatedKeysDictionary</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">added_record</span><span class="p">[</span><span class="n">field_name</span><span class="p">]:</span>
                <span class="n">new_indexes</span><span class="o">.</span><span class="n">set_at</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">index</span><span class="o">.</span><span class="n">set_at</span><span class="p">(</span><span class="n">added_record</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="n">added_record</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">IndexedQueryPlan</span><span class="p">(</span>
            <span class="n">indexes</span><span class="o">=</span><span class="n">new_indexes</span><span class="p">,</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="p">,</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">position_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dictionary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>

            <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">while</span> <span class="n">left</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">:</span>
                <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

                <span class="n">item</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">DictionaryItem</span><span class="p">,</span> <span class="n">index</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">get_at</span><span class="p">(</span><span class="n">center</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">center</span>

                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">right</span> <span class="o">=</span> <span class="n">center</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">center</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">return</span> <span class="n">left</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;No index on field </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1">!&#39;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">yield_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">DictionaryItem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">get_at</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">value_set</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Set</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">value_set</span><span class="o">.</span><span class="n">as_iterable</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">record</span>

    <span class="k">def</span> <span class="nf">get_greater_than</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_at</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">DictionaryItem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_at</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_from_index</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_greater_or_equal_than</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_at</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_from_index</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_equal_than</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dictionary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="n">item</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">DictionaryItem</span><span class="p">,</span> <span class="n">index</span><span class="o">.</span><span class="n">get_at</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="n">value_set</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Set</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">value_set</span><span class="o">.</span><span class="n">as_iterable</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">record</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;No index on field </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1">!&#39;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">yield_up_to_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index_up_to</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">count</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">index_up_to</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">DictionaryItem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">get_at</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">value_set</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Set</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">value_set</span><span class="o">.</span><span class="n">as_iterable</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">record</span>

    <span class="k">def</span> <span class="nf">get_lower_than</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_at</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">DictionaryItem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_at</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_up_to_index</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_lower_or_equal_than</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_at</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_up_to_index</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">IndexedSearchPlan</span><span class="p">(</span><span class="n">IndexedQueryPlan</span><span class="p">):</span>
    <span class="n">field_to_scan</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">operator</span><span class="p">:</span> <span class="n">Operator</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">field_to_scan</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">operator</span><span class="p">:</span> <span class="n">Operator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">indexes</span><span class="p">:</span> <span class="n">Dictionary</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">based_on</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">indexes</span><span class="o">=</span><span class="n">indexes</span><span class="p">,</span>
            <span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span>
            <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span>
            <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_to_scan</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;The field to scan should be specified!&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">operator</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;The operator should be specified!&#39;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">field_to_scan</span> <span class="o">=</span> <span class="n">field_to_scan</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="p">(</span>
                <span class="n">Lower</span><span class="p">,</span> <span class="n">LowerOrEqual</span><span class="p">,</span> <span class="n">Equal</span><span class="p">,</span> <span class="n">GreaterOrEqual</span><span class="p">,</span> <span class="n">Greater</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;The operator is not valid (</span><span class="si">{</span><span class="n">operator</span><span class="si">}</span><span class="s1">)!&#39;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="n">operator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">Equal</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_equal_than</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_to_scan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">Greater</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_greater_than</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_to_scan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">GreaterOrEqual</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_greater_or_equal_than</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_to_scan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">Lower</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lower_than</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_to_scan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">LowerOrEqual</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lower_or_equal_than</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_to_scan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">IndexedSearchPlan</span><span class="p">(</span>
            <span class="n">field_to_scan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field_to_scan</span><span class="p">,</span>
            <span class="n">operator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">indexes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">,</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">),</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">AndMerge</span><span class="p">(</span><span class="n">QueryPlan</span><span class="p">):</span>
    <span class="n">and_queries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">QueryPlan</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">and_queries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">QueryPlan</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">based_on</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">and_queries</span> <span class="o">=</span> <span class="n">and_queries</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">accumulators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">and_queries</span><span class="p">)):</span>
            <span class="n">accumulators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">record</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">and_queries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">execute</span><span class="p">()]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">and_queries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">accumulators</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="n">record</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">accumulators</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">accumulators</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">accumulators</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">record</span>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">AndMerge</span><span class="p">(</span>
            <span class="n">and_queries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">and_queries</span><span class="p">,</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">),</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">OrMerge</span><span class="p">(</span><span class="n">QueryPlan</span><span class="p">):</span>
    <span class="n">or_queries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">QueryPlan</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">or_queries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">QueryPlan</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">based_on</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">or_queries</span> <span class="o">=</span> <span class="n">or_queries</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">or_queries</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">record</span>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OrMerge</span><span class="p">(</span>
            <span class="n">or_queries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">or_queries</span><span class="p">,</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">),</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span>


<div class="viewcode-block" id="FromPlan">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.FromPlan">[docs]</a>
<span class="k">class</span> <span class="nc">FromPlan</span><span class="p">(</span><span class="n">IndexedQueryPlan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span>

<div class="viewcode-block" id="FromPlan.__init__">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.FromPlan.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">indexes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RepeatedKeysDictionary</span><span class="p">],</span>
                 <span class="n">based_on</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">,</span>
                 <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">alias</span> <span class="ow">and</span> <span class="n">indexes</span><span class="p">:</span>
            <span class="n">indexes</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">indexes</span>
                <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">indexes</span> <span class="ow">in</span> <span class="n">indexes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">indexes</span><span class="o">=</span><span class="n">indexes</span><span class="p">,</span> <span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span></div>


<div class="viewcode-block" id="FromPlan.execute">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.FromPlan.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">DBObject</span><span class="p">(</span>
                <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_setattr</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">result</span></div>


<div class="viewcode-block" id="FromPlan.optimize">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.FromPlan.optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">FromPlan</span><span class="p">(</span>
            <span class="n">alias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">),</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="WherePlan">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.WherePlan">[docs]</a>
<span class="k">class</span> <span class="nc">WherePlan</span><span class="p">(</span><span class="n">QueryPlan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query plan for filtering records based on an expression.</span>

<span class="sd">    This plan evaluates each record from the underlying `based_on` query plan</span>
<span class="sd">    against a filtering expression (`filter`). Records that satisfy the expression</span>
<span class="sd">    are passed downstream.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    - filter (Expression): An expression determining which records to retain.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">filter</span><span class="p">:</span> <span class="n">Expression</span>

<div class="viewcode-block" id="WherePlan.__init__">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.WherePlan.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">filter_spec</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="nb">filter</span><span class="p">:</span> <span class="n">Expression</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">based_on</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_spec</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">Expression</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">filter_spec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="nb">filter</span></div>


<div class="viewcode-block" id="WherePlan.execute">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.WherePlan.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the filtering logic over the input records.</span>

<span class="sd">        Each record is checked against the `filter` expression. Only records</span>
<span class="sd">        that match the filter are yielded.</span>

<span class="sd">        :return: A generator yielding filtered records.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">record</span></div>


<div class="viewcode-block" id="WherePlan.optimize">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.WherePlan.optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="n">based_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="p">,</span> <span class="n">IndexedQueryPlan</span><span class="p">):</span>
            <span class="c1"># Base QueryPlan has indexes! try to use them</span>
            <span class="n">indexed_base</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">IndexedQueryPlan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="p">)</span>
            <span class="n">indexed_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_name</span> <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexed_base</span><span class="o">.</span><span class="n">indexes</span><span class="p">]</span>
            <span class="n">used_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span> <span class="n">AndExpression</span><span class="p">):</span>
                <span class="n">and_filter</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">AndExpression</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">and_term</span> <span class="ow">in</span> <span class="n">and_filter</span><span class="o">.</span><span class="n">terms</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">and_term</span><span class="p">,</span> <span class="n">Term</span><span class="p">):</span>
                        <span class="n">term</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Term</span><span class="p">,</span> <span class="n">and_term</span><span class="p">)</span>
                        <span class="n">used_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>

                <span class="n">added_filters</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">used_fields</span><span class="p">:</span>
                    <span class="n">target_attribute</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">target_attribute</span>
                    <span class="n">operation</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">operation</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">target_attribute</span> <span class="ow">in</span> <span class="n">indexed_base</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
                        <span class="n">added_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IndexedSearchPlan</span><span class="p">(</span>
                            <span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span>
                            <span class="n">field_to_scan</span><span class="o">=</span><span class="n">target_attribute</span><span class="p">,</span>
                            <span class="n">operator</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span>
                            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
                        <span class="p">))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">added_filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">based_on</span> <span class="o">=</span> <span class="n">added_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">added_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">based_on</span> <span class="o">=</span> <span class="n">AndMerge</span><span class="p">(</span><span class="n">added_filters</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span> <span class="n">OrExpression</span><span class="p">):</span>
                <span class="n">and_filter</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">AndExpression</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">and_term</span> <span class="ow">in</span> <span class="n">and_filter</span><span class="o">.</span><span class="n">terms</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">and_term</span><span class="p">,</span> <span class="n">Term</span><span class="p">):</span>
                        <span class="n">term</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Term</span><span class="p">,</span> <span class="n">and_term</span><span class="p">)</span>
                        <span class="n">used_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>

                <span class="n">added_filters</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">used_fields</span><span class="p">:</span>
                    <span class="n">target_attribute</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">target_attribute</span>
                    <span class="n">operation</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">operation</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">target_attribute</span> <span class="ow">in</span> <span class="n">indexed_base</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
                        <span class="n">added_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IndexedSearchPlan</span><span class="p">(</span>
                            <span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span>
                            <span class="n">field_to_scan</span><span class="o">=</span><span class="n">target_attribute</span><span class="p">,</span>
                            <span class="n">operator</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span>
                            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
                        <span class="p">))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">added_filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">based_on</span> <span class="o">=</span> <span class="n">added_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">added_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">based_on</span> <span class="o">=</span> <span class="n">OrMerge</span><span class="p">(</span><span class="n">added_filters</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">WherePlan</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span>
            <span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span></div>
</div>



<span class="k">class</span> <span class="nc">AgreggatorFunction</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for aggregator functions.</span>

<span class="sd">    Aggregator functions perform operations (e.g., sum, average) over fields</span>
<span class="sd">    or records grouped under a common criteria. Each subclass implements</span>
<span class="sd">    its own logic for computing aggregate results.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the aggregation over a list of values.</span>

<span class="sd">        :param values: A list of values to aggregate.</span>
<span class="sd">        :type values: list</span>
<span class="sd">        :return: The result of the aggregation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">SumAgreggator</span><span class="p">(</span><span class="n">AgreggatorFunction</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sum aggregator function for computing the sum of a list of numeric values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the total sum of the given numeric values.</span>

<span class="sd">        :param values: A list of numeric values.</span>
<span class="sd">        :type values: list[float|int]</span>
<span class="sd">        :return: The sum of all values in the list.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">total_sum</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">total_sum</span>

<span class="k">class</span> <span class="nc">AvgAggregator</span><span class="p">(</span><span class="n">AgreggatorFunction</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="nb">sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="nb">sum</span> <span class="o">+=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>


<span class="k">class</span> <span class="nc">CountAggregator</span><span class="p">(</span><span class="n">AgreggatorFunction</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MinAgreggator</span><span class="p">(</span><span class="n">AgreggatorFunction</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">minimun</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">minimun</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">minimun</span><span class="p">:</span>
                <span class="n">minimun</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">minimun</span>


<span class="k">class</span> <span class="nc">MaxAggregator</span><span class="p">(</span><span class="n">AgreggatorFunction</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">maximun</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">maximun</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">maximun</span><span class="p">:</span>
                <span class="n">maximun</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">maximun</span>


<span class="k">class</span> <span class="nc">AgreggatorSpec</span><span class="p">:</span>
    <span class="n">agreggator_function</span><span class="p">:</span> <span class="n">AgreggatorFunction</span>
    <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agreggator_function</span><span class="p">:</span> <span class="n">AgreggatorFunction</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agreggator_function</span> <span class="o">=</span> <span class="n">agreggator_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span> <span class="o">=</span> <span class="n">field_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agreggator_function</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>


<div class="viewcode-block" id="GroupByPlan">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.GroupByPlan">[docs]</a>
<span class="k">class</span> <span class="nc">GroupByPlan</span><span class="p">(</span><span class="n">QueryPlan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query plan for grouping records and applying aggregate functions.</span>

<span class="sd">    This plan groups records based on the specified `group_fields`, then applies</span>
<span class="sd">    aggregate functions (`agreggated_fields`) to each group to compute summary</span>
<span class="sd">    statistics or values.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    - group_fields (list): Fields used for grouping records.</span>
<span class="sd">    - agreggated_fields (dict[str, AgreggatorSpec]): Aggregators applied to grouped data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">group_fields</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">agreggated_fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AgreggatorSpec</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<div class="viewcode-block" id="GroupByPlan.__init__">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.GroupByPlan.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">group_fields</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">agreggated_fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AgreggatorSpec</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">based_on</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">group_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;It&#39;s not possible to group by without a list of field names to use!&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_fields</span> <span class="o">=</span> <span class="n">group_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agreggated_fields</span> <span class="o">=</span> <span class="n">agreggated_fields</span></div>


<div class="viewcode-block" id="GroupByPlan.execute">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.GroupByPlan.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Group records by `group_fields` and compute aggregates.</span>

<span class="sd">        Records from the underlying `based_on` query are grouped in memory,</span>
<span class="sd">        and for each group, aggregate functions are applied as specified in</span>
<span class="sd">        `agreggated_fields`.</span>

<span class="sd">        :return: A generator yielding grouped and aggregated records.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grouped_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="c1"># Agrupar directamente por campos</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_fields</span><span class="p">)</span>
            <span class="n">grouped_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

        <span class="c1"># Procesar cada grupo</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">grouped_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_fields</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agreggated_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
                <span class="n">result</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">result_object</span> <span class="o">=</span> <span class="n">DBObject</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">result_object</span> <span class="o">=</span> <span class="n">result_object</span><span class="o">.</span><span class="n">_setattr</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">result_object</span></div>


<div class="viewcode-block" id="GroupByPlan.optimize">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.GroupByPlan.optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GroupByPlan</span><span class="p">(</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">),</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SelectPlan">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.SelectPlan">[docs]</a>
<span class="k">class</span> <span class="nc">SelectPlan</span><span class="p">(</span><span class="n">QueryPlan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that represents a plan for selecting specific fields from a query result.</span>

<span class="sd">    This class is used to generate a new set of records by applying field selection</span>
<span class="sd">    rules to an underlying `QueryPlan`. It allows specifying which fields to include</span>
<span class="sd">    and how they are derived from the original query results. Fields can be specified</span>
<span class="sd">    as direct attribute names from the original result or as callables to generate</span>
<span class="sd">    values dynamically.</span>

<span class="sd">    :ivar fields: Mapping of field names to values or callables defining how the</span>
<span class="sd">        field should be derived from the original query results.</span>
<span class="sd">    :type fields: dict[str, str | callable]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">callable</span><span class="p">]</span>

<div class="viewcode-block" id="SelectPlan.__init__">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.SelectPlan.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">based_on</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span></div>


<div class="viewcode-block" id="SelectPlan.execute">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.SelectPlan.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a transformation process over records fetched from the underlying</span>
<span class="sd">        source, applies field mappings to each record, and outputs the transformed</span>
<span class="sd">        results as a generator.</span>

<span class="sd">        The function processes records provided by `self.based_on.execute()`, applies</span>
<span class="sd">        field transformations defined in `self.fields`, and constructs new objects</span>
<span class="sd">        with the resultant field values. Each record is either derived through string</span>
<span class="sd">        attribute access or callable functions provided in the field mapping.</span>

<span class="sd">        :param self: The class instance containing the input source `based_on` and</span>
<span class="sd">            mapping definitions `fields`. The `fields` attribute defines which fields</span>
<span class="sd">            are processed and how transformations are applied.</span>

<span class="sd">        :return: Generator producing transformed objects created from the input</span>
<span class="sd">            records, enriched with fields mapped as per `self.fields`.</span>

<span class="sd">        :rtype: Generator[object, None, None]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">DBObject</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">dotted_fields</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">record</span>
                    <span class="k">for</span> <span class="n">path_component</span> <span class="ow">in</span> <span class="n">dotted_fields</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">path_component</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">DBObject</span><span class="o">.</span><span class="n">_setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SelectPlan.optimize">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.SelectPlan.optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SelectPlan</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">),</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="OrderByPlan">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.OrderByPlan">[docs]</a>
<span class="k">class</span> <span class="nc">OrderByPlan</span><span class="p">(</span><span class="n">QueryPlan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query plan for ordering records based on specified fields.</span>

<span class="sd">    This class consumes records from another query plan (`based_on`), sorts</span>
<span class="sd">    those records according to a given sorting specification (`sort_spec`),</span>
<span class="sd">    and optionally reverses the order.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    - sort_spec (list): A list of field names that dictate the sorting priority.</span>
<span class="sd">    - reversed (bool): Whether to reverse the result (descending order).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sort_spec</span><span class="p">:</span> <span class="nb">list</span>
    <span class="nb">reversed</span><span class="p">:</span> <span class="nb">bool</span>

<div class="viewcode-block" id="OrderByPlan.__init__">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.OrderByPlan.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">sort_spec</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                 <span class="nb">reversed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">based_on</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_spec</span> <span class="o">=</span> <span class="n">sort_spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reversed</span> <span class="o">=</span> <span class="nb">reversed</span></div>


<div class="viewcode-block" id="OrderByPlan.execute">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.OrderByPlan.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the order-by logic over the input records.</span>

<span class="sd">        Records are fetched from the `based_on` query plan, compared using the</span>
<span class="sd">        provided `sort_spec`, and sorted into ascending or descending order.</span>

<span class="sd">        The sorting uses a binary search to find the insertion point for new records,</span>
<span class="sd">        ensuring efficient insertion in sorted order.</span>

<span class="sd">        :return: A generator yielding sorted records.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ordered_output</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Compare two records based on the fields in `sort_spec`.</span>

<span class="sd">            Fields are evaluated in order of priority. If the two records are</span>
<span class="sd">            the same for a field, the next field in the list is used.</span>

<span class="sd">            :param a: The first record to compare.</span>
<span class="sd">            :param b: The second record to compare.</span>
<span class="sd">            :return: -1 if `a &lt; b`, 1 if `a &gt; b`, 0 if they are equal.</span>
<span class="sd">            :rtype: int</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">cmp</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_spec</span><span class="p">:</span>
                <span class="n">cmp</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="k">else</span> \
                    <span class="mi">1</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">cmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">return</span> <span class="n">cmp</span>

        <span class="n">ordered_output</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ordered_output</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ordered_output</span> <span class="o">=</span> <span class="n">ordered_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comparison</span> <span class="o">=</span> <span class="n">compare</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">ordered_output</span><span class="o">.</span><span class="n">get_at</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">comparison</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ordered_output</span> <span class="o">=</span> <span class="n">ordered_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Find the right place to insert the new record</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">right</span> <span class="o">=</span> <span class="n">ordered_output</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">center</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">while</span> <span class="n">left</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">:</span>
                        <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

                        <span class="n">item</span> <span class="o">=</span> <span class="n">ordered_output</span><span class="o">.</span><span class="n">get_at</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
                        <span class="n">comparison</span> <span class="o">=</span> <span class="n">compare</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">comparison</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">right</span> <span class="o">=</span> <span class="n">center</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">left</span> <span class="o">=</span> <span class="n">center</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="n">ordered_output</span> <span class="o">=</span> <span class="n">ordered_output</span><span class="o">.</span><span class="n">insert_at</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>

        <span class="c1"># At this point, all input has been ingested and ordered_output has an ascending order list</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reversed</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">ordered_output</span><span class="o">.</span><span class="n">count</span>
            <span class="k">while</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">yield</span> <span class="n">ordered_output</span><span class="o">.</span><span class="n">get_at</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ordered_output</span><span class="o">.</span><span class="n">as_iterable</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">item</span></div>


<div class="viewcode-block" id="OrderByPlan.optimize">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.OrderByPlan.optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OrderByPlan</span><span class="p">(</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">),</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="LimitPlan">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.LimitPlan">[docs]</a>
<span class="k">class</span> <span class="nc">LimitPlan</span><span class="p">(</span><span class="n">QueryPlan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a query plan that imposes a limit on the number of records to process.</span>

<span class="sd">    The LimitPlan class is used to define a query plan that enforces a constraint on</span>
<span class="sd">    the maximum number of records retrieved or processed from its associated query</span>
<span class="sd">    plan. This is achieved using a counter that tracks the number of records yielded</span>
<span class="sd">    and stops subsequent processing once the limit is reached. Additionally, the</span>
<span class="sd">    class provides optimization functionalities by enabling modifications of the</span>
<span class="sd">    underlying query plan while retaining the limit constraint. It is initialized</span>
<span class="sd">    with a required limit count and optional parameters to define its base plan and</span>
<span class="sd">    transaction context.</span>

<span class="sd">    :ivar limit_count: The maximum number of records to process.</span>
<span class="sd">    :type limit_count: int</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">limit_count</span><span class="p">:</span> <span class="nb">int</span>

<div class="viewcode-block" id="LimitPlan.__init__">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.LimitPlan.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">limit_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">based_on</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">limit_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Invalid limit count!&#39;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_count</span> <span class="o">=</span> <span class="n">limit_count</span></div>


<div class="viewcode-block" id="LimitPlan.execute">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.LimitPlan.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a generator function to fetch records from an underlying data source</span>
<span class="sd">        while imposing a limit on the number of records processed. This function</span>
<span class="sd">        iterates over a generator from the base execution and yields records until</span>
<span class="sd">        the specified limit is reached.</span>

<span class="sd">        :param self: Instance of the class containing execution logic.</span>
<span class="sd">        :return: A generator yielding records with a hard limit on the count, if</span>
<span class="sd">            applicable.</span>
<span class="sd">        :rtype: generator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_count</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">yield from</span> <span class="n">record</span></div>


<div class="viewcode-block" id="LimitPlan.optimize">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.LimitPlan.optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LimitPlan</span><span class="p">(</span>
            <span class="n">limit_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_count</span><span class="p">,</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">),</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="OffsetPlan">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.OffsetPlan">[docs]</a>
<span class="k">class</span> <span class="nc">OffsetPlan</span><span class="p">(</span><span class="n">QueryPlan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manage query execution with an offset, bypassing a specified number of initial records.</span>

<span class="sd">    This class extends the QueryPlan and introduces an offset mechanism to skip the initial</span>
<span class="sd">    records while executing the query plan. It leverages the functionality of the parent</span>
<span class="sd">    QueryPlan class while adding additional capabilities related to offset-based query</span>
<span class="sd">    processing. This class is commonly used in cases where paginated or incremental data</span>
<span class="sd">    retrieval is necessary.</span>

<span class="sd">    :ivar offset: Number of records to skip in the result set.</span>
<span class="sd">    :type offset: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span>

<div class="viewcode-block" id="OffsetPlan.__init__">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.OffsetPlan.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">based_on</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Invalid offset count!&#39;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span></div>


<div class="viewcode-block" id="OffsetPlan.execute">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.OffsetPlan.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the underlying data retrieval process while skipping a specified number of</span>
<span class="sd">        initial results. This method is useful in scenarios where data pagination or result</span>
<span class="sd">        offsetting is required. The retrieved records will be lazily returned using a generator,</span>
<span class="sd">        allowing for memory-efficient processing of potentially large datasets.</span>

<span class="sd">        :raises AttributeError: If ``self.based_on`` does not have an `execute` method.</span>
<span class="sd">        :param self: The instance on which the method is invoked.</span>
<span class="sd">        :type self: Any</span>
<span class="sd">        :param self.offset: The number of initial records to skip before yielding results.</span>
<span class="sd">        :type self.offset: int</span>

<span class="sd">        :returns: A generator of records from the underlying data source, starting from the</span>
<span class="sd">            ``self.offset`` index.</span>
<span class="sd">        :rtype: Generator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
            <span class="n">current_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">current_count</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">record</span></div>


<div class="viewcode-block" id="OffsetPlan.optimize">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.OffsetPlan.optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OffsetPlan</span><span class="p">(</span>
            <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">),</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="JoinPlan">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.JoinPlan">[docs]</a>
<span class="k">class</span> <span class="nc">JoinPlan</span><span class="p">(</span><span class="n">QueryPlan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    JoinPlan class facilitates the execution and optimization of a structured join</span>
<span class="sd">    operation, supporting multiple join types including external, left, right,</span>
<span class="sd">    inner, and outer join types. It extends QueryPlan and is integral in handling</span>
<span class="sd">    complex join queries in a data processing pipeline. Validation is performed</span>
<span class="sd">    to ensure appropriate join query and join type are provided.</span>

<span class="sd">    The class&#39;s purpose is to encapsulate the logic for various join operations</span>
<span class="sd">    while allowing optimization of the underlying query plan. Usage entails</span>
<span class="sd">    instantiating the class with the necessary parameters and calling the execute</span>
<span class="sd">    or optimize methods for respective operations.</span>

<span class="sd">    :ivar join_query: The query plan to be used for the join operation.</span>
<span class="sd">    :type join_query: QueryPlan</span>
<span class="sd">    :ivar join_type: The type of join operation to perform. Valid types include</span>
<span class="sd">        &#39;external&#39;, &#39;left&#39;, &#39;right&#39;, &#39;inner&#39;, &#39;external_left&#39;, &#39;external_right&#39;,</span>
<span class="sd">        and &#39;outer&#39;.</span>
<span class="sd">    :type join_type: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">join_query</span><span class="p">:</span> <span class="n">QueryPlan</span>
    <span class="n">join_type</span><span class="p">:</span> <span class="nb">str</span>

<div class="viewcode-block" id="JoinPlan.__init__">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.JoinPlan.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">join_query</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">join_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">based_on</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">join_query</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Missing join query!&#39;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_query</span> <span class="o">=</span> <span class="n">join_query</span>

        <span class="k">if</span> <span class="n">join_type</span> <span class="ow">and</span> <span class="n">join_type</span> <span class="ow">in</span> \
                <span class="p">(</span><span class="s1">&#39;external&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;external_left&#39;</span><span class="p">,</span> <span class="s1">&#39;external_right&#39;</span><span class="p">,</span> <span class="s1">&#39;outer&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">join_type</span> <span class="o">=</span> <span class="n">join_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Invalid join type </span><span class="si">{</span><span class="n">join_type</span><span class="si">}</span><span class="s1">!&#39;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="JoinPlan.execute">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.JoinPlan.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the join operation based on the specified join type and returns a list of</span>
<span class="sd">        results corresponding to the joined records.</span>

<span class="sd">        The joined operation type can be one of the following:</span>
<span class="sd">            - &#39;external&#39;</span>
<span class="sd">            - &#39;external_left&#39;</span>
<span class="sd">            - &#39;external_right&#39;</span>
<span class="sd">            - &#39;left&#39;</span>
<span class="sd">            - &#39;right&#39;</span>
<span class="sd">            - &#39;outer&#39;</span>
<span class="sd">            - &#39;inner&#39;</span>

<span class="sd">        Records are iteratively processed and combined, depending on the join type provided.</span>

<span class="sd">        :param self: Instance of the class performing the join operation.</span>
<span class="sd">        :return: A list containing the combined records resulting from the join operation.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;external&#39;</span><span class="p">,</span> <span class="s1">&#39;external_left&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;outer&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">base_record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
                <span class="k">yield from</span> <span class="n">base_record</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;external&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">base_record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">join_record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_query</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">DBObject</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">base_record</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">join_record</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">result</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;external&#39;</span><span class="p">,</span> <span class="s1">&#39;external_right&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;outer&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">join_record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_query</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
                <span class="k">yield from</span> <span class="n">join_record</span></div>


<div class="viewcode-block" id="JoinPlan.optimize">
<a class="viewcode-back" href="../../api/queries.html#proto_db.queries.JoinPlan.optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="n">previous_query</span> <span class="o">=</span> <span class="n">full_plan</span>
        <span class="k">while</span> <span class="n">previous_query</span> <span class="ow">and</span> <span class="n">previous_query</span><span class="o">.</span><span class="n">based_on</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">previous_query</span> <span class="o">=</span> <span class="n">previous_query</span><span class="o">.</span><span class="n">based_on</span>

        <span class="n">based_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">)</span>
        <span class="n">join_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_query</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">previous_query</span><span class="p">,</span> <span class="n">WherePlan</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">based_on</span><span class="p">,</span> <span class="n">FromPlan</span><span class="p">)</span> <span class="ow">and</span> <span class="n">based_on</span><span class="o">.</span><span class="n">alias</span><span class="p">:</span>
                <span class="n">based_on</span> <span class="o">=</span> <span class="n">WherePlan</span><span class="p">(</span>
                    <span class="nb">filter</span> <span class="o">=</span> <span class="n">previous_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">filter_by_alias</span><span class="p">({</span><span class="n">based_on</span><span class="o">.</span><span class="n">alias</span><span class="p">}),</span>
                    <span class="n">based_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="p">,</span>
                    <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">join_query</span><span class="p">,</span> <span class="n">FromPlan</span><span class="p">)</span> <span class="ow">and</span> <span class="n">join_query</span><span class="o">.</span><span class="n">alias</span><span class="p">:</span>
                <span class="n">join_query</span> <span class="o">=</span> <span class="n">WherePlan</span><span class="p">(</span>
                    <span class="nb">filter</span> <span class="o">=</span> <span class="n">previous_query</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">filter_by_alias</span><span class="p">({</span><span class="n">join_query</span><span class="o">.</span><span class="n">alias</span><span class="p">}),</span>
                    <span class="n">based_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_query</span><span class="p">,</span>
                    <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">JoinPlan</span><span class="p">(</span>
            <span class="n">join_query</span><span class="o">=</span><span class="n">join_query</span><span class="p">,</span>
            <span class="n">join_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">join_type</span><span class="p">,</span>
            <span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span></div>
</div>



<span class="k">class</span> <span class="nc">UnionPlan</span><span class="p">(</span><span class="n">QueryPlan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a plan that combines the results of two query plans using the union operation.</span>

<span class="sd">    This class facilitates combining the results of one query plan with those of</span>
<span class="sd">    another, effectively executing a union operation. It ensures that both query</span>
<span class="sd">    plans are valid and provides efficient execution and optimization mechanisms.</span>
<span class="sd">    The `UnionPlan` inherits from `QueryPlan` and extends its functionality</span>
<span class="sd">    to incorporate union-based operations.</span>

<span class="sd">    :ivar union_query: The query plan to be merged with the base query plan.</span>
<span class="sd">    :type union_query: QueryPlan</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">union_query</span><span class="p">:</span> <span class="n">QueryPlan</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">union_query</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">based_on</span><span class="p">:</span> <span class="n">QueryPlan</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">transaction</span><span class="p">:</span> <span class="n">ObjectTransaction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">atom_pointer</span><span class="p">:</span> <span class="n">AtomPointer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">based_on</span><span class="o">=</span><span class="n">based_on</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="n">atom_pointer</span><span class="o">=</span><span class="n">atom_pointer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">union_query</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtoValidationException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Missing union query!&#39;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">union_query</span> <span class="o">=</span> <span class="n">union_query</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">base_record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
            <span class="k">yield from</span> <span class="n">base_record</span>

        <span class="k">for</span> <span class="n">union_record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">union_query</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
            <span class="k">yield from</span> <span class="n">union_record</span>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">:</span> <span class="n">QueryPlan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryPlan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UnionPlan</span><span class="p">(</span>
            <span class="n">union_query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">union_query</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">),</span>
            <span class="n">based_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">based_on</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">full_plan</span><span class="p">),</span>
            <span class="n">transaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction</span>
        <span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, ProtoBase Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>