

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Query System &mdash; ProtoBase 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Vector Support" href="vectors.html" />
    <link rel="prev" title="Secondary Indexes" href="indexes.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            ProtoBase
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">Architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">API Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="core.html">Core Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="storage.html">Storage Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_structures.html">Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="indexes.html">Secondary Indexes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Query System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#new-in-this-release">New in this release</a></li>
<li class="toctree-l3"><a class="reference internal" href="#query-plans">Query Plans</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#queryplan">QueryPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fromplan">FromPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#whereplan">WherePlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#joinplan">JoinPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#groupbyplan">GroupByPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#orderbyplan">OrderByPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#selectplan">SelectPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#countplan">CountPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#countresultplan">CountResultPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limitplan">LimitPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#offsetplan">OffsetPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#listplan">ListPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unnestplan">UnnestPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#collectionfieldplan">CollectionFieldPlan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#indexedrangesearchplan">IndexedRangeSearchPlan</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#optimized-counting">Optimized Counting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#indexedsearchplan-count">IndexedSearchPlan.count()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#andmerge-count">AndMerge.count()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ormerge-count">OrMerge.count()</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#range-operators-between">Range Operators (Between)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#proto_db.queries.Between"><code class="docutils literal notranslate"><span class="pre">Between</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#index-aware-and-optimization">Index-aware AND optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage-examples">Usage Examples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#basic-query">Basic Query</a></li>
<li class="toctree-l4"><a class="reference internal" href="#filtering">Filtering</a></li>
<li class="toctree-l4"><a class="reference internal" href="#projection">Projection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sorting">Sorting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#grouping">Grouping</a></li>
<li class="toctree-l4"><a class="reference internal" href="#joining">Joining</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pagination">Pagination</a></li>
<li class="toctree-l4"><a class="reference internal" href="#counting">Counting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chaining">Chaining</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="vectors.html">Vector Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="linq.html">LINQ-like API</a></li>
<li class="toctree-l2"><a class="reference internal" href="exceptions.html">Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="fsm.html">Finite State Machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#core-components">Core Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#storage-layer">Storage Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#data-structures">Data Structures</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#query-system">Query System</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Query System</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#new-in-this-release">New in this release</a></li>
<li class="toctree-l4"><a class="reference internal" href="#query-plans">Query Plans</a></li>
<li class="toctree-l4"><a class="reference internal" href="#optimized-counting">Optimized Counting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#range-operators-between">Range Operators (Between)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#index-aware-and-optimization">Index-aware AND optimization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage-examples">Usage Examples</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#exceptions">Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#finite-state-machine">Finite State Machine</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_usage.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ProtoBase</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">API Reference</a></li>
      <li class="breadcrumb-item active">Query System</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/api/queries.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="query-system">
<h1>Query System<a class="headerlink" href="#query-system" title="Link to this heading"></a></h1>
<p id="module-proto_db.queries">This module provides the query system of ProtoBase, which allows for complex data manipulation and retrieval.</p>
<section id="new-in-this-release">
<h2>New in this release<a class="headerlink" href="#new-in-this-release" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Range operators between[]/()/[)/(] with proper bound inclusivity via the Between operator.</p></li>
<li><p>Collection-oriented plans: UnnestPlan and CollectionFieldPlan.</p></li>
<li><p>Index-aware filtering optimization in WherePlan for AND conjunctions using progressive intersection ordered by selectivity.</p></li>
<li><p>Range pushdown over indexes via IndexedRangeSearchPlan.</p></li>
</ul>
</section>
<section id="query-plans">
<h2>Query Plans<a class="headerlink" href="#query-plans" title="Link to this heading"></a></h2>
<section id="queryplan">
<h3>QueryPlan<a class="headerlink" href="#queryplan" title="Link to this heading"></a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="proto_db.common.QueryPlan">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">proto_db.common.</span></span><span class="sig-name descname"><span class="pre">QueryPlan</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">based_on</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/common.html#QueryPlan"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.common.QueryPlan" title="Link to this definition"></a></dt>
<dd><p>Maintains the structure and logic for a query execution plan.</p>
<p>This class serves as a blueprint for creating and managing query execution
plans. It is designed to abstract the process of execution and optimization
of queries in systems, enabling extension for specific use cases or query types.
Being an abstract class, it defines the required methods that subclasses must
implement for their respective functionality.</p>
<dl class="field-list simple">
<dt class="field-odd">Variables<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>based_on</strong> – The base query plan that this instance derives from or is built upon.</p>
</dd>
<dt class="field-even">Parameters<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>transaction</strong> (<em>AbstractTransaction</em>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="proto_db.common.QueryPlan.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">based_on</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/common.html#QueryPlan.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.common.QueryPlan.__init__" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>transaction</strong> (<em>AbstractTransaction</em>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.common.QueryPlan.execute">
<em class="property"><span class="k"><span class="pre">abstractmethod</span></span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">execute</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/common.html#QueryPlan.execute"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.common.QueryPlan.execute" title="Link to this definition"></a></dt>
<dd><p>Executes the query plan and returns the results.</p>
<p>This method processes the query plan and retrieves the data according to
the plan’s specifications. Implementations should define the specific
execution logic based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>A list of results from executing the query plan.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>list</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.common.QueryPlan.optimize">
<em class="property"><span class="k"><span class="pre">abstractmethod</span></span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">full_plan</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/common.html#QueryPlan.optimize"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.common.QueryPlan.optimize" title="Link to this definition"></a></dt>
<dd><p>Optimizes the query plan for better performance.</p>
<p>This method analyzes the current query plan and the full plan context to
create a more efficient execution strategy. Implementations should define
specific optimization techniques based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>full_plan</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>) – The complete query plan to be optimized.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The optimized query plan.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.common.QueryPlan.count">
<span class="sig-name descname"><span class="pre">count</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/common.html#QueryPlan.count"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.common.QueryPlan.count" title="Link to this definition"></a></dt>
<dd><p>Default count implementation: iterate through execute() and count the results.
Subclasses can override for more efficient counting.</p>
<dl class="field-list simple">
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>int</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<p>The <code class="docutils literal notranslate"><span class="pre">QueryPlan</span></code> class is the base class for all query plans in ProtoBase. It provides methods for query execution and chaining.</p>
</section>
<section id="fromplan">
<h3>FromPlan<a class="headerlink" href="#fromplan" title="Link to this heading"></a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="proto_db.queries.FromPlan">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">proto_db.queries.</span></span><span class="sig-name descname"><span class="pre">FromPlan</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">alias</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">indexes</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">based_on</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#FromPlan"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.FromPlan" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>alias</strong> (<em>str</em>)</p></li>
<li><p><strong>indexes</strong> (<a class="reference internal" href="data_structures.html#proto_db.dictionaries.Dictionary" title="proto_db.dictionaries.Dictionary"><em>Dictionary</em></a>)</p></li>
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>transaction</strong> (<em>AbstractTransaction</em>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.FromPlan.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">alias</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">indexes</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">based_on</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#FromPlan.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.FromPlan.__init__" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>alias</strong> (<em>str</em>)</p></li>
<li><p><strong>indexes</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><a class="reference internal" href="data_structures.html#proto_db.dictionaries.RepeatedKeysDictionary" title="proto_db.dictionaries.RepeatedKeysDictionary"><em>RepeatedKeysDictionary</em></a><em>]</em>)</p></li>
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>transaction</strong> (<a class="reference internal" href="core.html#proto_db.db_access.ObjectTransaction" title="proto_db.db_access.ObjectTransaction"><em>ObjectTransaction</em></a>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.FromPlan.execute">
<span class="sig-name descname"><span class="pre">execute</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#FromPlan.execute"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.FromPlan.execute" title="Link to this definition"></a></dt>
<dd><p>Executes the query plan and returns the results.</p>
<p>This method processes the query plan and retrieves the data according to
the plan’s specifications. Implementations should define the specific
execution logic based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>A list of results from executing the query plan.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>list</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.FromPlan.optimize">
<span class="sig-name descname"><span class="pre">optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">full_plan</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#FromPlan.optimize"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.FromPlan.optimize" title="Link to this definition"></a></dt>
<dd><p>Optimizes the query plan for better performance.</p>
<p>This method analyzes the current query plan and the full plan context to
create a more efficient execution strategy. Implementations should define
specific optimization techniques based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>full_plan</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>) – The complete query plan to be optimized.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The optimized query plan.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">FromPlan</span></code> is the starting point for queries. It takes a collection as input, provides an iterator over the collection, and can be used as the basis for other query plans.</p>
</section>
<section id="whereplan">
<h3>WherePlan<a class="headerlink" href="#whereplan" title="Link to this heading"></a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="proto_db.queries.WherePlan">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">proto_db.queries.</span></span><span class="sig-name descname"><span class="pre">WherePlan</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filter_spec</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filter</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">based_on</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#WherePlan"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.WherePlan" title="Link to this definition"></a></dt>
<dd><p>Query plan for filtering records based on an expression.</p>
<p>This plan evaluates each record from the underlying <cite>based_on</cite> query plan
against a filtering expression (<cite>filter</cite>). Records that satisfy the expression
are passed downstream.</p>
<p>Attributes:
- filter (Expression): An expression determining which records to retain.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>filter_spec</strong> (<em>list</em>)</p></li>
<li><p><strong>filter</strong> (<em>Expression</em>)</p></li>
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>transaction</strong> (<em>AbstractTransaction</em>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.WherePlan.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filter_spec</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filter</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">based_on</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#WherePlan.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.WherePlan.__init__" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>filter_spec</strong> (<em>list</em>)</p></li>
<li><p><strong>filter</strong> (<em>Expression</em>)</p></li>
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>transaction</strong> (<a class="reference internal" href="core.html#proto_db.db_access.ObjectTransaction" title="proto_db.db_access.ObjectTransaction"><em>ObjectTransaction</em></a>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.WherePlan.execute">
<span class="sig-name descname"><span class="pre">execute</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#WherePlan.execute"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.WherePlan.execute" title="Link to this definition"></a></dt>
<dd><p>Execute the filtering logic over the input records.</p>
<p>Optimized path:
- If the filter is an AndExpression and the underlying plan exposes indexes</p>
<blockquote>
<div><p>(IndexedQueryPlan), build candidate sets for indexable terms (==, in, contains,
between, &lt;, &lt;=, &gt;, &gt;=) using the index, sort by selectivity (len), and intersect
progressively. Then apply residual filtering on the reduced set only.</p>
</div></blockquote>
<ul class="simple">
<li><p>Otherwise, fallback to linear scan.</p></li>
</ul>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>A generator yielding filtered records.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>list</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.WherePlan.optimize">
<span class="sig-name descname"><span class="pre">optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">full_plan</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#WherePlan.optimize"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.WherePlan.optimize" title="Link to this definition"></a></dt>
<dd><p>Optimizes the current execution plan node.</p>
<p>This method is a core part of the query optimizer. It applies several
strategies to transform the query plan into a more efficient equivalent.
The primary optimizations include:
1.  Filter Reordering: For AND expressions, reorder predicates to execute</p>
<blockquote>
<div><p>the most selective and least expensive ones first.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Predicate Pushdown: Attempt to move the filter logic (“predicate”)
further down the execution tree, closer to the data source. This
reduces the volume of data processed in upstream operators (like Joins).</p></li>
<li><p>Index Utilization: If a predicate can be satisfied using an index,
transform this plan node into an <cite>IndexedSearchPlan</cite>.</p></li>
</ol>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>full_plan</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>) – The root of the entire query plan, providing context if needed.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>An optimized <cite>QueryPlan</cite>, which may be a different type of node
(e.g., <cite>IndexedSearchPlan</cite>) or a reconfigured <cite>WherePlan</cite>.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">WherePlan</span></code> filters records based on a condition. It takes a filter function and a base plan, returns only records that satisfy the condition, and can be chained with other query plans.</p>
</section>
<section id="joinplan">
<h3>JoinPlan<a class="headerlink" href="#joinplan" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">JoinPlan</span></code> joins multiple data sources. It takes two plans and a join condition, returns records that satisfy the join condition, and supports inner, left, right, and full joins.</p>
</section>
<section id="groupbyplan">
<h3>GroupByPlan<a class="headerlink" href="#groupbyplan" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">GroupByPlan</span></code> groups records by a key. It takes a key function and a base plan, returns groups of records with the same key, and can be used for aggregation.</p>
</section>
<section id="orderbyplan">
<h3>OrderByPlan<a class="headerlink" href="#orderbyplan" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">OrderByPlan</span></code> sorts records. It takes a key function and a base plan, returns records sorted by the key, and supports ascending and descending order.</p>
</section>
<section id="selectplan">
<h3>SelectPlan<a class="headerlink" href="#selectplan" title="Link to this heading"></a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="proto_db.queries.SelectPlan">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">proto_db.queries.</span></span><span class="sig-name descname"><span class="pre">SelectPlan</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fields</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">based_on</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#SelectPlan"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.SelectPlan" title="Link to this definition"></a></dt>
<dd><p>A query plan that selects and transforms fields from records produced by another query plan.</p>
<p>This plan allows for both direct field mapping (renaming fields) and dynamic field
generation through callable functions. It’s useful for projecting and transforming
data in a query pipeline.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>fields</strong> (<em>dict</em>)</p></li>
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>transaction</strong> (<em>AbstractTransaction</em>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.SelectPlan.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fields</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">based_on</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#SelectPlan.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.SelectPlan.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize a SelectPlan with field mappings and a base query plan.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>fields</strong> (<em>dict</em>) – A dictionary mapping output field names to either:
- Source field names (strings) for direct mapping
- Callable functions that take a record and return a value</p></li>
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>) – The query plan that produces the records to transform</p></li>
<li><p><strong>transaction</strong> (<a class="reference internal" href="core.html#proto_db.db_access.ObjectTransaction" title="proto_db.db_access.ObjectTransaction"><em>ObjectTransaction</em></a>) – The transaction context</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>) – Pointer to the atom in storage</p></li>
<li><p><strong>**kwargs</strong> – Additional arguments</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.SelectPlan.execute">
<span class="sig-name descname"><span class="pre">execute</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#SelectPlan.execute"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.SelectPlan.execute" title="Link to this definition"></a></dt>
<dd><p>Execute the plan, transforming records from the base plan according to field mappings.</p>
<p>For each record from the base plan, this method creates a new record with fields
mapped according to the field specification provided at initialization.</p>
<dl class="field-list simple">
<dt class="field-odd">Yields<span class="colon">:</span></dt>
<dd class="field-odd"><p>Transformed records with the specified field mappings applied.</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>Any exception that might be raised by callable field mappings.</strong> – </p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.SelectPlan.optimize">
<span class="sig-name descname"><span class="pre">optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">full_plan</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#SelectPlan.optimize"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.SelectPlan.optimize" title="Link to this definition"></a></dt>
<dd><p>Optimize this plan and its dependencies.</p>
<p>This method delegates optimization to the underlying plan and then
creates a new SelectPlan with the optimized base.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>full_plan</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>) – The complete query plan for context</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>An optimized version of this plan</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">SelectPlan</span></code> projects specific fields. It takes a projection function and a base plan, returns transformed records, and can be used to extract specific fields.</p>
</section>
<section id="countplan">
<h3>CountPlan<a class="headerlink" href="#countplan" title="Link to this heading"></a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="proto_db.queries.CountPlan">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">proto_db.queries.</span></span><span class="sig-name descname"><span class="pre">CountPlan</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">based_on</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#CountPlan"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.CountPlan" title="Link to this definition"></a></dt>
<dd><p>A query plan that counts the results from a sub-plan.
This plan is optimized to use index counts whenever possible,
avoiding full data iteration.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>transaction</strong> (<em>AbstractTransaction</em>)</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.CountPlan.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">based_on</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#CountPlan.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.CountPlan.__init__" title="Link to this definition"></a></dt>
<dd><p>Initializes the CountPlan.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>) – The underlying plan whose results will be counted.</p></li>
<li><p><strong>transaction</strong> (<a class="reference internal" href="core.html#proto_db.db_access.ObjectTransaction" title="proto_db.db_access.ObjectTransaction"><em>ObjectTransaction</em></a>) – The active transaction.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.CountPlan.execute">
<span class="sig-name descname"><span class="pre">execute</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#CountPlan.execute"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.CountPlan.execute" title="Link to this definition"></a></dt>
<dd><p>Executes the count. If no optimization is possible,
it iterates through the sub-plan’s results and counts them.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>123}].</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>A list containing a single dictionary with the count, e.g., [{‘count’</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.CountPlan.optimize">
<span class="sig-name descname"><span class="pre">optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">full_plan</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#CountPlan.optimize"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.CountPlan.optimize" title="Link to this definition"></a></dt>
<dd><p>Optimizes the counting process.</p>
<p>If the underlying plan can provide a count efficiently (e.g., it’s an
indexed search), this method will delegate the counting to it.
Otherwise, it returns itself to perform a standard iteration count.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>A plan that can provide the count, potentially a new optimized plan
or itself.</p>
</dd>
<dt class="field-even">Parameters<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>full_plan</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">CountPlan</span></code> counts the results from a sub-plan. It takes a base plan and returns a single record with the count. It is optimized to use index counts whenever possible, avoiding full data iteration.</p>
</section>
<section id="countresultplan">
<h3>CountResultPlan<a class="headerlink" href="#countresultplan" title="Link to this heading"></a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="proto_db.queries.CountResultPlan">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">proto_db.queries.</span></span><span class="sig-name descname"><span class="pre">CountResultPlan</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">count_value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#CountResultPlan"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.CountResultPlan" title="Link to this definition"></a></dt>
<dd><p>A terminal plan that simply holds and returns a pre-calculated count.
This is the result of an optimized CountPlan.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>count_value</strong> (<em>int</em>)</p></li>
<li><p><strong>transaction</strong> (<em>AbstractTransaction</em>)</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.CountResultPlan.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">count_value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#CountResultPlan.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.CountResultPlan.__init__" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>count_value</strong> (<em>int</em>)</p></li>
<li><p><strong>transaction</strong> (<a class="reference internal" href="core.html#proto_db.db_access.ObjectTransaction" title="proto_db.db_access.ObjectTransaction"><em>ObjectTransaction</em></a>)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.CountResultPlan.execute">
<span class="sig-name descname"><span class="pre">execute</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#CountResultPlan.execute"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.CountResultPlan.execute" title="Link to this definition"></a></dt>
<dd><p>Executes the query plan and returns the results.</p>
<p>This method processes the query plan and retrieves the data according to
the plan’s specifications. Implementations should define the specific
execution logic based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>A list of results from executing the query plan.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>list[dict]</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.CountResultPlan.optimize">
<span class="sig-name descname"><span class="pre">optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">full_plan</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#CountResultPlan.optimize"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.CountResultPlan.optimize" title="Link to this definition"></a></dt>
<dd><p>Optimizes the query plan for better performance.</p>
<p>This method analyzes the current query plan and the full plan context to
create a more efficient execution strategy. Implementations should define
specific optimization techniques based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>full_plan</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>) – The complete query plan to be optimized.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The optimized query plan.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">CountResultPlan</span></code> is a terminal plan that holds and returns a pre-calculated count. It is the result of an optimized CountPlan.</p>
</section>
<section id="limitplan">
<h3>LimitPlan<a class="headerlink" href="#limitplan" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">LimitPlan</span></code> limits the number of records returned. It takes a limit and a base plan, and returns at most the specified number of records.</p>
</section>
<section id="offsetplan">
<h3>OffsetPlan<a class="headerlink" href="#offsetplan" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">OffsetPlan</span></code> skips a number of records. It takes an offset and a base plan, and returns records starting from the specified offset.</p>
</section>
<section id="listplan">
<h3>ListPlan<a class="headerlink" href="#listplan" title="Link to this heading"></a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="proto_db.queries.ListPlan">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">proto_db.queries.</span></span><span class="sig-name descname"><span class="pre">ListPlan</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">base_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#ListPlan"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.ListPlan" title="Link to this definition"></a></dt>
<dd><p>Create a QueryPlan from a python list</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>base_list</strong> (<em>list</em>)</p></li>
<li><p><strong>transaction</strong> (<em>AbstractTransaction</em>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.ListPlan.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">base_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#ListPlan.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.ListPlan.__init__" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>base_list</strong> (<em>list</em>)</p></li>
<li><p><strong>transaction</strong> (<a class="reference internal" href="core.html#proto_db.db_access.ObjectTransaction" title="proto_db.db_access.ObjectTransaction"><em>ObjectTransaction</em></a>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.ListPlan.execute">
<span class="sig-name descname"><span class="pre">execute</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#ListPlan.execute"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.ListPlan.execute" title="Link to this definition"></a></dt>
<dd><p>Executes the query plan and returns the results.</p>
<p>This method processes the query plan and retrieves the data according to
the plan’s specifications. Implementations should define the specific
execution logic based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>A list of results from executing the query plan.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>list</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.ListPlan.optimize">
<span class="sig-name descname"><span class="pre">optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">full_plan</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#ListPlan.optimize"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.ListPlan.optimize" title="Link to this definition"></a></dt>
<dd><p>Optimizes the query plan for better performance.</p>
<p>This method analyzes the current query plan and the full plan context to
create a more efficient execution strategy. Implementations should define
specific optimization techniques based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>full_plan</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>) – The complete query plan to be optimized.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The optimized query plan.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">ListPlan</span></code> is a simple plan that wraps a list. It provides an iterator over the list and can be used as the basis for other query plans.</p>
</section>
<section id="unnestplan">
<h3>UnnestPlan<a class="headerlink" href="#unnestplan" title="Link to this heading"></a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="proto_db.queries.UnnestPlan">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">proto_db.queries.</span></span><span class="sig-name descname"><span class="pre">UnnestPlan</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">source_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">element_alias</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">based_on</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#UnnestPlan"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.UnnestPlan" title="Link to this definition"></a></dt>
<dd><p>Plan that flattens a collection from each input record.
- source_path: dotted path string or callable(record) -&gt; iterable
- element_alias: if provided, the element is attached to the original record under this key; otherwise the element replaces the record.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>element_alias</strong> (<em>str</em><em> | </em><em>None</em>)</p></li>
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>transaction</strong> (<em>AbstractTransaction</em>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.UnnestPlan.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">source_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">element_alias</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">based_on</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#UnnestPlan.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.UnnestPlan.__init__" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>element_alias</strong> (<em>str</em><em> | </em><em>None</em>)</p></li>
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>transaction</strong> (<a class="reference internal" href="core.html#proto_db.db_access.ObjectTransaction" title="proto_db.db_access.ObjectTransaction"><em>ObjectTransaction</em></a>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.UnnestPlan.execute">
<span class="sig-name descname"><span class="pre">execute</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#UnnestPlan.execute"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.UnnestPlan.execute" title="Link to this definition"></a></dt>
<dd><p>Executes the query plan and returns the results.</p>
<p>This method processes the query plan and retrieves the data according to
the plan’s specifications. Implementations should define the specific
execution logic based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>A list of results from executing the query plan.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.UnnestPlan.optimize">
<span class="sig-name descname"><span class="pre">optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">full_plan</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#UnnestPlan.optimize"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.UnnestPlan.optimize" title="Link to this definition"></a></dt>
<dd><p>Optimizes the query plan for better performance.</p>
<p>This method analyzes the current query plan and the full plan context to
create a more efficient execution strategy. Implementations should define
specific optimization techniques based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>full_plan</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>) – The complete query plan to be optimized.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The optimized query plan.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">UnnestPlan</span></code> flattens an iterable found in each input record (by dotted path or callable). It emits one row per element. If an element_alias is provided, the element is attached to the original record under that key; otherwise the element replaces the record.</p>
</section>
<section id="collectionfieldplan">
<h3>CollectionFieldPlan<a class="headerlink" href="#collectionfieldplan" title="Link to this heading"></a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="proto_db.queries.CollectionFieldPlan">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">proto_db.queries.</span></span><span class="sig-name descname"><span class="pre">CollectionFieldPlan</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">field_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">subplan_builder</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">based_on</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#CollectionFieldPlan"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.CollectionFieldPlan" title="Link to this definition"></a></dt>
<dd><p>For each left record, executes a subplan built from it and attaches the collected results as a list under field_name.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>field_name</strong> (<em>str</em>)</p></li>
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>transaction</strong> (<em>AbstractTransaction</em>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.CollectionFieldPlan.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">field_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">subplan_builder</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">based_on</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#CollectionFieldPlan.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.CollectionFieldPlan.__init__" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>field_name</strong> (<em>str</em>)</p></li>
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>transaction</strong> (<a class="reference internal" href="core.html#proto_db.db_access.ObjectTransaction" title="proto_db.db_access.ObjectTransaction"><em>ObjectTransaction</em></a>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.CollectionFieldPlan.execute">
<span class="sig-name descname"><span class="pre">execute</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#CollectionFieldPlan.execute"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.CollectionFieldPlan.execute" title="Link to this definition"></a></dt>
<dd><p>Executes the query plan and returns the results.</p>
<p>This method processes the query plan and retrieves the data according to
the plan’s specifications. Implementations should define the specific
execution logic based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>A list of results from executing the query plan.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.CollectionFieldPlan.optimize">
<span class="sig-name descname"><span class="pre">optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">full_plan</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#CollectionFieldPlan.optimize"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.CollectionFieldPlan.optimize" title="Link to this definition"></a></dt>
<dd><p>Optimizes the query plan for better performance.</p>
<p>This method analyzes the current query plan and the full plan context to
create a more efficient execution strategy. Implementations should define
specific optimization techniques based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>full_plan</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>) – The complete query plan to be optimized.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The optimized query plan.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">CollectionFieldPlan</span></code> evaluates a per-record subplan and assigns the collected results (as a list) to the given field name, preserving the original record.</p>
</section>
<section id="indexedrangesearchplan">
<h3>IndexedRangeSearchPlan<a class="headerlink" href="#indexedrangesearchplan" title="Link to this heading"></a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="proto_db.queries.IndexedRangeSearchPlan">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">proto_db.queries.</span></span><span class="sig-name descname"><span class="pre">IndexedRangeSearchPlan</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">field_to_scan</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lo</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hi</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">include_lower</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">include_upper</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">indexes</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">based_on</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#IndexedRangeSearchPlan"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.IndexedRangeSearchPlan" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>field_to_scan</strong> (<em>str</em>)</p></li>
<li><p><strong>lo</strong> (<em>object</em>)</p></li>
<li><p><strong>hi</strong> (<em>object</em>)</p></li>
<li><p><strong>include_lower</strong> (<em>bool</em>)</p></li>
<li><p><strong>include_upper</strong> (<em>bool</em>)</p></li>
<li><p><strong>indexes</strong> (<a class="reference internal" href="data_structures.html#proto_db.dictionaries.Dictionary" title="proto_db.dictionaries.Dictionary"><em>Dictionary</em></a>)</p></li>
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
<li><p><strong>transaction</strong> (<em>AbstractTransaction</em>)</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.IndexedRangeSearchPlan.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">field_to_scan</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lo</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hi</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">include_lower</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">include_upper</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">indexes</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">based_on</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atom_pointer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#IndexedRangeSearchPlan.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.IndexedRangeSearchPlan.__init__" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>field_to_scan</strong> (<em>str</em>)</p></li>
<li><p><strong>include_lower</strong> (<em>bool</em>)</p></li>
<li><p><strong>include_upper</strong> (<em>bool</em>)</p></li>
<li><p><strong>indexes</strong> (<a class="reference internal" href="data_structures.html#proto_db.dictionaries.Dictionary" title="proto_db.dictionaries.Dictionary"><em>Dictionary</em></a>)</p></li>
<li><p><strong>based_on</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>)</p></li>
<li><p><strong>atom_pointer</strong> (<a class="reference internal" href="core.html#proto_db.common.AtomPointer" title="proto_db.common.AtomPointer"><em>AtomPointer</em></a>)</p></li>
<li><p><strong>transaction</strong> (<a class="reference internal" href="core.html#proto_db.db_access.ObjectTransaction" title="proto_db.db_access.ObjectTransaction"><em>ObjectTransaction</em></a>)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.IndexedRangeSearchPlan.execute">
<span class="sig-name descname"><span class="pre">execute</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#IndexedRangeSearchPlan.execute"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.IndexedRangeSearchPlan.execute" title="Link to this definition"></a></dt>
<dd><p>Executes the query plan and returns the results.</p>
<p>This method processes the query plan and retrieves the data according to
the plan’s specifications. Implementations should define the specific
execution logic based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>A list of results from executing the query plan.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.IndexedRangeSearchPlan.optimize">
<span class="sig-name descname"><span class="pre">optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">full_plan</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#IndexedRangeSearchPlan.optimize"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.IndexedRangeSearchPlan.optimize" title="Link to this definition"></a></dt>
<dd><p>Optimizes the query plan for better performance.</p>
<p>This method analyzes the current query plan and the full plan context to
create a more efficient execution strategy. Implementations should define
specific optimization techniques based on the query plan type.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>full_plan</strong> (<a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a>) – The complete query plan to be optimized.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The optimized query plan.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#proto_db.common.QueryPlan" title="proto_db.common.QueryPlan"><em>QueryPlan</em></a></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.IndexedRangeSearchPlan.count">
<span class="sig-name descname"><span class="pre">count</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#IndexedRangeSearchPlan.count"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.IndexedRangeSearchPlan.count" title="Link to this definition"></a></dt>
<dd><p>Default count implementation: iterate through execute() and count the results.
Subclasses can override for more efficient counting.</p>
<dl class="field-list simple">
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>int</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<p>This plan iterates only the index buckets whose keys fall within a specified range, respecting inclusive/exclusive bounds. It is produced by WherePlan.optimize when a Between operator applies to an indexed field.</p>
</section>
</section>
<section id="optimized-counting">
<h2>Optimized Counting<a class="headerlink" href="#optimized-counting" title="Link to this heading"></a></h2>
<p>Several query plan classes implement optimized counting methods to improve performance when only the count of results is needed, not the actual data. These optimizations avoid iterating through all records when possible.</p>
<section id="indexedsearchplan-count">
<h3>IndexedSearchPlan.count()<a class="headerlink" href="#indexedsearchplan-count" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">IndexedSearchPlan</span></code> class provides a fast count method that leverages the underlying index count. This avoids iterating over the actual data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using an indexed field for counting is much faster</span>
<span class="n">indexed_search</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">IndexedSearchPlan</span><span class="p">(</span>
    <span class="n">field_to_scan</span><span class="o">=</span><span class="s2">&quot;city&quot;</span><span class="p">,</span>
    <span class="n">operator</span><span class="o">=</span><span class="s2">&quot;==&quot;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;New York&quot;</span><span class="p">,</span>
    <span class="n">based_on</span><span class="o">=</span><span class="n">indexed_from_plan</span><span class="p">,</span>
    <span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span>
<span class="p">)</span>

<span class="c1"># Get the count directly without iterating</span>
<span class="n">count</span> <span class="o">=</span> <span class="n">indexed_search</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="andmerge-count">
<h3>AndMerge.count()<a class="headerlink" href="#andmerge-count" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">AndMerge</span></code> class optimizes counting for the intersection of sub-queries. It iterates the smaller result set and checks for existence in the larger one, without materializing full objects.</p>
</section>
<section id="ormerge-count">
<h3>OrMerge.count()<a class="headerlink" href="#ormerge-count" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">OrMerge</span></code> class optimizes counting for the union of sub-queries. It uses a set to efficiently combine IDs and get the final count of unique results.</p>
</section>
</section>
<section id="range-operators-between">
<h2>Range Operators (Between)<a class="headerlink" href="#range-operators-between" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="proto_db.queries.Between">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">proto_db.queries.</span></span><span class="sig-name descname"><span class="pre">Between</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">include_lower</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">include_upper</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#Between"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.Between" title="Link to this definition"></a></dt>
<dd><p>Range comparison operator with configurable bound inclusivity.
<cite>value</cite> must be a tuple (lo, hi).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>include_lower</strong> (<em>bool</em>)</p></li>
<li><p><strong>include_upper</strong> (<em>bool</em>)</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.Between.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">include_lower</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">include_upper</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#Between.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.Between.__init__" title="Link to this definition"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>include_lower</strong> (<em>bool</em>)</p></li>
<li><p><strong>include_upper</strong> (<em>bool</em>)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="proto_db.queries.Between.match">
<span class="sig-name descname"><span class="pre">match</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">source</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/proto_db/queries.html#Between.match"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#proto_db.queries.Between.match" title="Link to this definition"></a></dt>
<dd><p>This method is an abstract method that should be implemented in derived
classes. It is designed to match the provided source against a specific
value and return a result based on this matching process. The exact
implementation and criteria of the match are dependent on the
implementation in the subclass.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>source</strong> – The primary input against which the matching process
will be performed. The exact nature of ‘source’ depends on the
implementation in the subclass.</p></li>
<li><p><strong>value</strong> – Optional value against which ‘source’ will be matched.
If not provided, the behavior may vary based on the subclass
implementation.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The result of the matching process. The exact type and
content of the returned value depend on the specific implementation
in the subclass.</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<p>The <code class="docutils literal notranslate"><span class="pre">Between</span></code> operator supports configurable bound inclusivity. Four canonical spellings are supported by the operator factory:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">between[]</span></code>: inclusive lower and upper bounds</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">between()</span></code>: exclusive lower and upper bounds</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">between(]</span></code>: exclusive lower, inclusive upper</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">between[)</span></code>: inclusive lower, exclusive upper</p></li>
</ul>
<p>Each <code class="docutils literal notranslate"><span class="pre">Term</span></code> using <code class="docutils literal notranslate"><span class="pre">Between</span></code> expects a value tuple <code class="docutils literal notranslate"><span class="pre">(lo,</span> <span class="pre">hi)</span></code>. Example compiled expression: <code class="docutils literal notranslate"><span class="pre">['age',</span> <span class="pre">'between()',</span> <span class="pre">10,</span> <span class="pre">20]</span></code>.</p>
</section>
<section id="index-aware-and-optimization">
<h2>Index-aware AND optimization<a class="headerlink" href="#index-aware-and-optimization" title="Link to this heading"></a></h2>
<p>When the filter is an <code class="docutils literal notranslate"><span class="pre">AndExpression</span></code> and the underlying plan exposes secondary indexes for the referenced fields, <code class="docutils literal notranslate"><span class="pre">WherePlan.execute</span></code> builds per-term candidate sets from the indexes, sorts them by selectivity (size) ascending, and performs a progressive intersection with early exit. Non-indexable residual predicates are applied only to the reduced set. This can drastically reduce the work on large datasets.</p>
</section>
<section id="usage-examples">
<h2>Usage Examples<a class="headerlink" href="#usage-examples" title="Link to this heading"></a></h2>
<section id="basic-query">
<h3>Basic Query<a class="headerlink" href="#basic-query" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">proto_db</span>

<span class="c1"># Create a list of dictionaries</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>

<span class="c1"># Add some users</span>
<span class="n">user1</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">()</span>
<span class="n">user1</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;John&quot;</span>
<span class="n">user1</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">user1</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;New York&quot;</span>
<span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span>

<span class="n">user2</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">()</span>
<span class="n">user2</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Jane&quot;</span>
<span class="n">user2</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">user2</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Boston&quot;</span>
<span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span>

<span class="n">user3</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">()</span>
<span class="n">user3</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bob&quot;</span>
<span class="n">user3</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">35</span>
<span class="n">user3</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;New York&quot;</span>
<span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user3</span><span class="p">)</span>

<span class="c1"># Create a query plan</span>
<span class="n">from_plan</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">FromPlan</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>

<span class="c1"># Execute the query</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">from_plan</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>  <span class="c1"># Output: John, Jane, Bob</span>
</pre></div>
</div>
</section>
<section id="filtering">
<h3>Filtering<a class="headerlink" href="#filtering" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filter users from New York</span>
<span class="n">where_plan</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">WherePlan</span><span class="p">(</span>
    <span class="nb">filter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;New York&quot;</span><span class="p">,</span>
    <span class="n">based_on</span><span class="o">=</span><span class="n">from_plan</span>
<span class="p">)</span>

<span class="c1"># Execute the query</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">where_plan</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>  <span class="c1"># Output: John, Bob</span>
</pre></div>
</div>
</section>
<section id="projection">
<h3>Projection<a class="headerlink" href="#projection" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Project only the name and age fields</span>
<span class="n">select_plan</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">SelectPlan</span><span class="p">(</span>
    <span class="n">projection</span><span class="o">=</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]},</span>
    <span class="n">based_on</span><span class="o">=</span><span class="n">from_plan</span>
<span class="p">)</span>

<span class="c1"># Execute the query</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">select_plan</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Output: John: 30, Jane: 25, Bob: 35</span>
</pre></div>
</div>
</section>
<section id="sorting">
<h3>Sorting<a class="headerlink" href="#sorting" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sort users by age</span>
<span class="n">order_plan</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">OrderByPlan</span><span class="p">(</span>
    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">],</span>
    <span class="n">based_on</span><span class="o">=</span><span class="n">from_plan</span>
<span class="p">)</span>

<span class="c1"># Execute the query</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">order_plan</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Output: Jane: 25, John: 30, Bob: 35</span>
</pre></div>
</div>
</section>
<section id="grouping">
<h3>Grouping<a class="headerlink" href="#grouping" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Group users by city</span>
<span class="n">group_plan</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">GroupByPlan</span><span class="p">(</span>
    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">],</span>
    <span class="n">based_on</span><span class="o">=</span><span class="n">from_plan</span>
<span class="p">)</span>

<span class="c1"># Execute the query</span>
<span class="k">for</span> <span class="n">city</span><span class="p">,</span> <span class="n">users_in_city</span> <span class="ow">in</span> <span class="n">group_plan</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">users_in_city</span><span class="p">)</span><span class="si">}</span><span class="s2"> users&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users_in_city</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Output:</span>
<span class="c1"># New York: 2 users</span>
<span class="c1">#   John</span>
<span class="c1">#   Bob</span>
<span class="c1"># Boston: 1 user</span>
<span class="c1">#   Jane</span>
</pre></div>
</div>
</section>
<section id="joining">
<h3>Joining<a class="headerlink" href="#joining" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a list of cities</span>
<span class="n">cities</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>

<span class="c1"># Add some cities</span>
<span class="n">city1</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">()</span>
<span class="n">city1</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;New York&quot;</span>
<span class="n">city1</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;USA&quot;</span>
<span class="n">cities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">city1</span><span class="p">)</span>

<span class="n">city2</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">()</span>
<span class="n">city2</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Boston&quot;</span>
<span class="n">city2</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;USA&quot;</span>
<span class="n">cities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">city2</span><span class="p">)</span>

<span class="c1"># Create a query plan for cities</span>
<span class="n">cities_plan</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">FromPlan</span><span class="p">(</span><span class="n">cities</span><span class="p">)</span>

<span class="c1"># Join users and cities</span>
<span class="n">join_plan</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">JoinPlan</span><span class="p">(</span>
    <span class="n">left</span><span class="o">=</span><span class="n">from_plan</span><span class="p">,</span>
    <span class="n">right</span><span class="o">=</span><span class="n">cities_plan</span><span class="p">,</span>
    <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">user</span><span class="p">,</span> <span class="n">city</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">city</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Execute the query</span>
<span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">city</span> <span class="ow">in</span> <span class="n">join_plan</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> lives in </span><span class="si">{</span><span class="n">city</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">city</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Output:</span>
<span class="c1"># John lives in New York, USA</span>
<span class="c1"># Jane lives in Boston, USA</span>
<span class="c1"># Bob lives in New York, USA</span>
</pre></div>
</div>
</section>
<section id="pagination">
<h3>Pagination<a class="headerlink" href="#pagination" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Limit to 2 users</span>
<span class="n">limit_plan</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">LimitPlan</span><span class="p">(</span>
    <span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">based_on</span><span class="o">=</span><span class="n">from_plan</span>
<span class="p">)</span>

<span class="c1"># Execute the query</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">limit_plan</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>  <span class="c1"># Output: John, Jane</span>

<span class="c1"># Skip the first user</span>
<span class="n">offset_plan</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">OffsetPlan</span><span class="p">(</span>
    <span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">based_on</span><span class="o">=</span><span class="n">from_plan</span>
<span class="p">)</span>

<span class="c1"># Execute the query</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">offset_plan</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>  <span class="c1"># Output: Jane, Bob</span>

<span class="c1"># Combine limit and offset for pagination</span>
<span class="n">page_plan</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">LimitPlan</span><span class="p">(</span>
    <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">based_on</span><span class="o">=</span><span class="n">proto_db</span><span class="o">.</span><span class="n">OffsetPlan</span><span class="p">(</span>
        <span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">based_on</span><span class="o">=</span><span class="n">from_plan</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Execute the query</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">page_plan</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>  <span class="c1"># Output: Jane</span>
</pre></div>
</div>
</section>
<section id="counting">
<h3>Counting<a class="headerlink" href="#counting" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Count all users</span>
<span class="n">count_plan</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">CountPlan</span><span class="p">(</span>
    <span class="n">based_on</span><span class="o">=</span><span class="n">from_plan</span><span class="p">,</span>
    <span class="n">transaction</span><span class="o">=</span><span class="n">from_plan</span><span class="o">.</span><span class="n">transaction</span>
<span class="p">)</span>

<span class="c1"># Execute the query</span>
<span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">count_plan</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total users: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Output: Total users: 3</span>

<span class="c1"># Count users from New York</span>
<span class="n">filtered_count_plan</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">CountPlan</span><span class="p">(</span>
    <span class="n">based_on</span><span class="o">=</span><span class="n">proto_db</span><span class="o">.</span><span class="n">WherePlan</span><span class="p">(</span>
        <span class="nb">filter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;New York&quot;</span><span class="p">,</span>
        <span class="n">based_on</span><span class="o">=</span><span class="n">from_plan</span><span class="p">,</span>
        <span class="n">transaction</span><span class="o">=</span><span class="n">from_plan</span><span class="o">.</span><span class="n">transaction</span>
    <span class="p">),</span>
    <span class="n">transaction</span><span class="o">=</span><span class="n">from_plan</span><span class="o">.</span><span class="n">transaction</span>
<span class="p">)</span>

<span class="c1"># Execute the query</span>
<span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">filtered_count_plan</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Users from New York: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Output: Users from New York: 2</span>
</pre></div>
</div>
</section>
<section id="chaining">
<h3>Chaining<a class="headerlink" href="#chaining" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Chain multiple operations</span>
<span class="n">chain_plan</span> <span class="o">=</span> <span class="n">proto_db</span><span class="o">.</span><span class="n">SelectPlan</span><span class="p">(</span>
    <span class="n">projection</span><span class="o">=</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]},</span>
    <span class="n">based_on</span><span class="o">=</span><span class="n">proto_db</span><span class="o">.</span><span class="n">WherePlan</span><span class="p">(</span>
        <span class="nb">filter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">,</span>
        <span class="n">based_on</span><span class="o">=</span><span class="n">proto_db</span><span class="o">.</span><span class="n">OrderByPlan</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="n">based_on</span><span class="o">=</span><span class="n">from_plan</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Execute the query</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">chain_plan</span><span class="o">.</span><span class="n">execute</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>  <span class="c1"># Output: Bob, John</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="indexes.html" class="btn btn-neutral float-left" title="Secondary Indexes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="vectors.html" class="btn btn-neutral float-right" title="Vector Support" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, ProtoBase Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>